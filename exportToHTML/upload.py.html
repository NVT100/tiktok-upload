<html>
<head>
<title>upload.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #5f826b; font-style: italic;}
.s1 { color: #bcbec4;}
.s2 { color: #cf8e6d;}
.s3 { color: #bcbec4;}
.s4 { color: #6aab73;}
.s5 { color: #2aacb8;}
.s6 { color: #7a7e85;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
upload.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
`tiktok_uploader` module for uploading videos to TikTok 
 
Key Functions 
------------- 
upload_video : Uploads a single TikTok video 
upload_videos : Uploads multiple TikTok videos 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">os</span><span class="s3">.</span><span class="s1">path </span><span class="s2">import </span><span class="s1">abspath</span><span class="s3">, </span><span class="s1">exists</span>
<span class="s2">from </span><span class="s1">typing </span><span class="s2">import </span><span class="s1">List</span>
<span class="s2">import </span><span class="s1">time</span>
<span class="s2">import </span><span class="s1">pytz</span>
<span class="s2">import </span><span class="s1">datetime</span>

<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">common</span><span class="s3">.</span><span class="s1">by </span><span class="s2">import </span><span class="s1">By</span>

<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">common</span><span class="s3">.</span><span class="s1">action_chains </span><span class="s2">import </span><span class="s1">ActionChains</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">support</span><span class="s3">.</span><span class="s1">ui </span><span class="s2">import </span><span class="s1">WebDriverWait</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">support </span><span class="s2">import </span><span class="s1">expected_conditions </span><span class="s2">as </span><span class="s1">EC</span>
<span class="s2">from </span><span class="s1">selenium</span><span class="s3">.</span><span class="s1">webdriver</span><span class="s3">.</span><span class="s1">common</span><span class="s3">.</span><span class="s1">keys </span><span class="s2">import </span><span class="s1">Keys</span>

<span class="s2">from </span><span class="s1">tiktok_uploader</span><span class="s3">.</span><span class="s1">browsers </span><span class="s2">import </span><span class="s1">get_browser</span>
<span class="s2">from </span><span class="s1">tiktok_uploader</span><span class="s3">.</span><span class="s1">auth </span><span class="s2">import </span><span class="s1">AuthBackend</span>
<span class="s2">from </span><span class="s1">tiktok_uploader </span><span class="s2">import </span><span class="s1">config</span><span class="s3">, </span><span class="s1">logger</span>
<span class="s2">from </span><span class="s1">tiktok_uploader</span><span class="s3">.</span><span class="s1">utils </span><span class="s2">import </span><span class="s1">bold</span><span class="s3">, </span><span class="s1">green</span>
<span class="s2">from </span><span class="s1">tiktok_uploader </span><span class="s2">import</span><span class="s3">*</span>


<span class="s2">def </span><span class="s1">upload_video</span><span class="s3">(</span><span class="s1">filename</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">description</span><span class="s3">=</span><span class="s4">''</span><span class="s3">, </span><span class="s1">schedule</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">username</span><span class="s3">=</span><span class="s4">''</span><span class="s3">,</span>
                 <span class="s1">password</span><span class="s3">=</span><span class="s4">''</span><span class="s3">, </span><span class="s1">cookies</span><span class="s3">=</span><span class="s4">''</span><span class="s3">, </span><span class="s1">sessionid</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cookies_list</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">cookies_str</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">proxy</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Uploads a single TikTok video. 
 
    Consider using `upload_videos` if using multiple videos 
 
    Parameters 
    ---------- 
    filename : str 
        The path to the video to upload 
    description : str 
        The description to set for the video 
    schedule: datetime.datetime 
        The datetime to schedule the video, must be naive or aware with UTC timezone, if naive it will be aware with UTC timezone 
    cookies : str 
        The cookies to use for uploading 
    sessionid: str 
        The `sessionid` is the only required cookie for uploading, 
            but it is recommended to use all cookies to avoid detection 
    &quot;&quot;&quot;</span>
    <span class="s1">auth </span><span class="s3">= </span><span class="s1">AuthBackend</span><span class="s3">(</span><span class="s1">username</span><span class="s3">=</span><span class="s1">username</span><span class="s3">, </span><span class="s1">password</span><span class="s3">=</span><span class="s1">password</span><span class="s3">, </span><span class="s1">cookies</span><span class="s3">=</span><span class="s1">cookies</span><span class="s3">,</span>
                       <span class="s1">cookies_list</span><span class="s3">=</span><span class="s1">cookies_list</span><span class="s3">, </span><span class="s1">cookies_str</span><span class="s3">=</span><span class="s1">cookies_str</span><span class="s3">, </span><span class="s1">sessionid</span><span class="s3">=</span><span class="s1">sessionid</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">upload_videos</span><span class="s3">(</span>
            <span class="s1">videos</span><span class="s3">=[ { </span><span class="s4">'path'</span><span class="s3">: </span><span class="s1">filename</span><span class="s3">, </span><span class="s4">'description'</span><span class="s3">: </span><span class="s1">description</span><span class="s3">, </span><span class="s4">'schedule'</span><span class="s3">: </span><span class="s1">schedule </span><span class="s3">} ],</span>
            <span class="s1">auth</span><span class="s3">=</span><span class="s1">auth</span><span class="s3">,</span>
            <span class="s1">proxy</span><span class="s3">=</span><span class="s1">proxy</span><span class="s3">,</span>
            <span class="s3">*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span>
        <span class="s3">)</span>


<span class="s2">def </span><span class="s1">upload_videos</span><span class="s3">(</span><span class="s1">videos</span><span class="s3">: </span><span class="s1">list </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">auth</span><span class="s3">: </span><span class="s1">AuthBackend </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">proxy</span><span class="s3">: </span><span class="s1">dict </span><span class="s3">= </span><span class="s2">None</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">=</span><span class="s4">'chrome'</span><span class="s3">,</span>
                  <span class="s1">browser_agent</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">on_complete</span><span class="s3">=</span><span class="s2">None</span><span class="s3">, </span><span class="s1">headless</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, </span><span class="s1">num_retires </span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s5">1</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    Uploads multiple videos to TikTok 
 
    Parameters 
    ---------- 
    videos : list 
        A list of dictionaries containing the video's ('path') and description ('description') 
    proxy: dict 
        A dictionary containing the proxy user, pass, host and port 
    browser : str 
        The browser to use for uploading 
    browser_agent : selenium.webdriver 
        A selenium webdriver object to use for uploading 
    on_complete : function 
        A function to call when the upload is complete 
    headless : bool 
        Whether or not the browser should be run in headless mode 
    num_retries : int 
        The number of retries to attempt if the upload fails 
    options : SeleniumOptions 
        The options to pass into the browser -&gt; custom privacy settings, etc. 
    *args : 
        Additional arguments to pass into the upload function 
    **kwargs : 
        Additional keyword arguments to pass into the upload function 
 
    Returns 
    ------- 
    failed : list 
        A list of videos which failed to upload 
    &quot;&quot;&quot;</span>
    <span class="s1">videos </span><span class="s3">= </span><span class="s1">_convert_videos_dict</span><span class="s3">(</span><span class="s1">videos</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">videos </span><span class="s2">and </span><span class="s1">len</span><span class="s3">(</span><span class="s1">videos</span><span class="s3">) &gt; </span><span class="s5">1</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">&quot;Uploading %d videos&quot;</span><span class="s3">, </span><span class="s1">len</span><span class="s3">(</span><span class="s1">videos</span><span class="s3">))</span>

    <span class="s2">if not </span><span class="s1">browser_agent</span><span class="s3">: </span><span class="s6"># user-specified browser agent</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'Create a %s browser instance %s'</span><span class="s3">, </span><span class="s1">browser</span><span class="s3">,</span>
                    <span class="s4">'in headless mode' </span><span class="s2">if </span><span class="s1">headless </span><span class="s2">else </span><span class="s4">''</span><span class="s3">)</span>
        <span class="s1">driver </span><span class="s3">= </span><span class="s1">get_browser</span><span class="s3">(</span><span class="s1">name</span><span class="s3">=</span><span class="s1">browser</span><span class="s3">, </span><span class="s1">headless</span><span class="s3">=</span><span class="s1">headless</span><span class="s3">, </span><span class="s1">proxy</span><span class="s3">=</span><span class="s1">proxy</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'Using user-defined browser agent'</span><span class="s3">)</span>
        <span class="s1">driver </span><span class="s3">= </span><span class="s1">browser_agent</span>
    <span class="s2">if </span><span class="s1">proxy</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">proxy_is_working</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">proxy</span><span class="s3">[</span><span class="s4">'host'</span><span class="s3">]):</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Proxy is working'</span><span class="s3">))</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">'Proxy is not working'</span><span class="s3">)</span>
            <span class="s1">driver</span><span class="s3">.</span><span class="s1">quit</span><span class="s3">()</span>
            <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s4">'Proxy is not working'</span><span class="s3">)</span>
    <span class="s1">driver </span><span class="s3">= </span><span class="s1">auth</span><span class="s3">.</span><span class="s1">authenticate_agent</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>

    <span class="s1">failed </span><span class="s3">= []</span>
    <span class="s6"># uploads each video</span>
    <span class="s2">for </span><span class="s1">video </span><span class="s2">in </span><span class="s1">videos</span><span class="s3">:</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">abspath</span><span class="s3">(</span><span class="s1">video</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'path'</span><span class="s3">))</span>
            <span class="s1">description </span><span class="s3">= </span><span class="s1">video</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'description'</span><span class="s3">, </span><span class="s4">''</span><span class="s3">)</span>
            <span class="s1">schedule </span><span class="s3">= </span><span class="s1">video</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'schedule'</span><span class="s3">, </span><span class="s2">None</span><span class="s3">)</span>

            <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s4">'Posting %s%s'</span><span class="s3">, </span><span class="s1">bold</span><span class="s3">(</span><span class="s1">video</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s4">'path'</span><span class="s3">)),</span>
            <span class="s4">f'</span><span class="s2">\n{</span><span class="s4">&quot; &quot; </span><span class="s3">* </span><span class="s5">15</span><span class="s2">}</span><span class="s4">with description: </span><span class="s2">{</span><span class="s1">bold</span><span class="s3">(</span><span class="s1">description</span><span class="s3">)</span><span class="s2">}</span><span class="s4">' </span><span class="s2">if </span><span class="s1">description </span><span class="s2">else </span><span class="s4">''</span><span class="s3">)</span>

            <span class="s6"># Video must be of supported type</span>
            <span class="s2">if not </span><span class="s1">_check_valid_path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                <span class="s1">print</span><span class="s3">(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">path</span><span class="s2">} </span><span class="s4">is invalid, skipping'</span><span class="s3">)</span>
                <span class="s1">failed</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">video</span><span class="s3">)</span>
                <span class="s2">continue</span>

            <span class="s6"># Video must have a valid datetime for tiktok's scheduler</span>
            <span class="s2">if </span><span class="s1">schedule</span><span class="s3">:</span>
                <span class="s1">timezone </span><span class="s3">= </span><span class="s1">pytz</span><span class="s3">.</span><span class="s1">UTC</span>
                <span class="s2">if </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">tzinfo </span><span class="s2">is None</span><span class="s3">:</span>
                    <span class="s1">schedule </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">astimezone</span><span class="s3">(</span><span class="s1">timezone</span><span class="s3">)</span>
                <span class="s2">elif </span><span class="s1">int</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">utcoffset</span><span class="s3">().</span><span class="s1">total_seconds</span><span class="s3">()) == </span><span class="s5">0</span><span class="s3">:  </span><span class="s6"># Equivalent to UTC</span>
                    <span class="s1">schedule </span><span class="s3">= </span><span class="s1">timezone</span><span class="s3">.</span><span class="s1">localize</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">schedule</span><span class="s2">} </span><span class="s4">is invalid, the schedule datetime must be naive or aware with UTC timezone, skipping'</span><span class="s3">)</span>
                    <span class="s1">failed</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">video</span><span class="s3">)</span>
                    <span class="s2">continue</span>

                <span class="s1">valid_tiktok_minute_multiple </span><span class="s3">= </span><span class="s5">5</span>
                <span class="s1">schedule </span><span class="s3">= </span><span class="s1">_get_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">, </span><span class="s1">valid_tiktok_minute_multiple</span><span class="s3">)</span>
                <span class="s2">if not </span><span class="s1">_check_valid_schedule</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">):</span>
                    <span class="s1">print</span><span class="s3">(</span><span class="s4">f'</span><span class="s2">{</span><span class="s1">schedule</span><span class="s2">} </span><span class="s4">is invalid, the schedule datetime must be as least 20 minutes in the future, and a maximum of 10 days, skipping'</span><span class="s3">)</span>
                    <span class="s1">failed</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">video</span><span class="s3">)</span>
                    <span class="s2">continue</span>

            <span class="s1">complete_upload_form</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">path</span><span class="s3">, </span><span class="s1">description</span><span class="s3">, </span><span class="s1">schedule</span><span class="s3">,</span>
                                 <span class="s1">num_retires</span><span class="s3">=</span><span class="s1">num_retires</span><span class="s3">, </span><span class="s1">headless</span><span class="s3">=</span><span class="s1">headless</span><span class="s3">,</span>
                                 <span class="s3">*</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">exception</span><span class="s3">:</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">'Failed to upload %s'</span><span class="s3">, </span><span class="s1">path</span><span class="s3">)</span>
            <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">exception</span><span class="s3">)</span>
            <span class="s1">failed</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">video</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">on_complete </span><span class="s2">is </span><span class="s1">callable</span><span class="s3">: </span><span class="s6"># calls the user-specified on-complete function</span>
            <span class="s1">on_complete</span><span class="s3">(</span><span class="s1">video</span><span class="s3">)</span>

    <span class="s2">if </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'quit_on_end'</span><span class="s3">]:</span>
        <span class="s1">driver</span><span class="s3">.</span><span class="s1">quit</span><span class="s3">()</span>

    <span class="s2">return </span><span class="s1">failed</span>


<span class="s2">def </span><span class="s1">complete_upload_form</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">path</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">description</span><span class="s3">: </span><span class="s1">str</span><span class="s3">, </span><span class="s1">schedule</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">, </span><span class="s1">headless</span><span class="s3">=</span><span class="s2">False</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Actually uploads each video 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
        The selenium webdriver to use for uploading 
    path : str 
        The path to the video to upload 
    &quot;&quot;&quot;</span>
    <span class="s1">_go_to_upload</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>
    <span class="s1">_set_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">path</span><span class="s3">=</span><span class="s1">path</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">_set_interactivity</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">)</span>
    <span class="s1">_set_description</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">description</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">schedule</span><span class="s3">:</span>
        <span class="s1">_set_schedule_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">schedule</span><span class="s3">)</span>
    <span class="s1">_post_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_go_to_upload</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Navigates to the upload page, switches to the iframe and waits for it to load 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    &quot;&quot;&quot;</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Navigating to upload page'</span><span class="s3">))</span>

    <span class="s6"># if the upload page is not open, navigate to it</span>
    <span class="s2">if </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">current_url </span><span class="s3">!= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'paths'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">]:</span>
        <span class="s1">driver</span><span class="s3">.</span><span class="s1">get</span><span class="s3">(</span><span class="s1">config</span><span class="s3">[</span><span class="s4">'paths'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">])</span>
    <span class="s6"># otherwise, refresh the page and accept the reload alert</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">_refresh_with_alert</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>

    <span class="s6"># changes to the iframe</span>
    <span class="s1">iframe_selector </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'iframe'</span><span class="s3">])</span>
        <span class="s3">)</span>
    <span class="s1">iframe </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">iframe_selector</span><span class="s3">)</span>
    <span class="s1">driver</span><span class="s3">.</span><span class="s1">switch_to</span><span class="s3">.</span><span class="s1">frame</span><span class="s3">(</span><span class="s1">iframe</span><span class="s3">)</span>

    <span class="s6"># waits for the iframe to load</span>
    <span class="s1">root_selector </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">((</span><span class="s1">By</span><span class="s3">.</span><span class="s1">ID</span><span class="s3">, </span><span class="s4">'root'</span><span class="s3">))</span>
    <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">root_selector</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_set_description</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">description</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Sets the description of the video 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    description : str 
        The description to set 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">description </span><span class="s2">is None</span><span class="s3">:</span>
        <span class="s6"># if no description is provided, filename</span>
        <span class="s2">return</span>

    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Setting description'</span><span class="s3">))</span>

    <span class="s6"># Remove any characters outside the BMP range (emojis, etc)</span>
    <span class="s1">description </span><span class="s3">= </span><span class="s1">description</span><span class="s3">.</span><span class="s1">encode</span><span class="s3">(</span><span class="s4">'ascii'</span><span class="s3">, </span><span class="s4">'ignore'</span><span class="s3">).</span><span class="s1">decode</span><span class="s3">(</span><span class="s4">'ascii'</span><span class="s3">)</span>

    <span class="s1">saved_description </span><span class="s3">= </span><span class="s1">description </span><span class="s6"># save the description in case it fails</span>

    <span class="s1">desc </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'description'</span><span class="s3">])</span>

    <span class="s6"># desc populates with filename before clearing</span>
    <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s2">lambda </span><span class="s1">driver</span><span class="s3">: </span><span class="s1">desc</span><span class="s3">.</span><span class="s1">text </span><span class="s3">!= </span><span class="s4">''</span><span class="s3">)</span>

    <span class="s1">_clear</span><span class="s3">(</span><span class="s1">desc</span><span class="s3">)</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s2">while </span><span class="s1">description</span><span class="s3">:</span>
            <span class="s1">nearest_mention </span><span class="s3">= </span><span class="s1">description</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">'@'</span><span class="s3">)</span>
            <span class="s1">nearest_hash </span><span class="s3">= </span><span class="s1">description</span><span class="s3">.</span><span class="s1">find</span><span class="s3">(</span><span class="s4">'#'</span><span class="s3">)</span>

            <span class="s2">if </span><span class="s1">nearest_mention </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">or </span><span class="s1">nearest_hash </span><span class="s3">== </span><span class="s5">0</span><span class="s3">:</span>
                <span class="s1">desc</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s4">'@' </span><span class="s2">if </span><span class="s1">nearest_mention </span><span class="s3">== </span><span class="s5">0 </span><span class="s2">else </span><span class="s4">'#'</span><span class="s3">)</span>

                <span class="s6"># wait for the frames to load</span>
                <span class="s1">time</span><span class="s3">.</span><span class="s1">sleep</span><span class="s3">(</span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">])</span>

                <span class="s1">name </span><span class="s3">= </span><span class="s1">description</span><span class="s3">[</span><span class="s5">1</span><span class="s3">:].</span><span class="s1">split</span><span class="s3">(</span><span class="s4">' '</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">]</span>
                <span class="s2">if </span><span class="s1">nearest_mention </span><span class="s3">== </span><span class="s5">0</span><span class="s3">: </span><span class="s6"># @ case</span>
                    <span class="s1">mention_xpath </span><span class="s3">= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'mention_box'</span><span class="s3">]</span>
                    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">((</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">mention_xpath</span><span class="s3">))</span>
                    <span class="s1">mention_box </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>
                    <span class="s1">mention_box</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">desc</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>

                <span class="s1">time</span><span class="s3">.</span><span class="s1">sleep</span><span class="s3">(</span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">])</span>

                <span class="s2">if </span><span class="s1">nearest_mention </span><span class="s3">== </span><span class="s5">0</span><span class="s3">: </span><span class="s6"># @ case</span>
                    <span class="s1">mention_xpath </span><span class="s3">= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'mentions'</span><span class="s3">].</span><span class="s1">format</span><span class="s3">(</span><span class="s4">'@' </span><span class="s3">+ </span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">((</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">mention_xpath</span><span class="s3">))</span>
                <span class="s2">else</span><span class="s3">:</span>
                    <span class="s1">hashtag_xpath </span><span class="s3">= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'hashtags'</span><span class="s3">].</span><span class="s1">format</span><span class="s3">(</span><span class="s1">name</span><span class="s3">)</span>
                    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">((</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">hashtag_xpath</span><span class="s3">))</span>

                <span class="s1">elem </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>

                <span class="s1">ActionChains</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">).</span><span class="s1">move_to_element</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">).</span><span class="s1">click</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">).</span><span class="s1">perform</span><span class="s3">()</span>

                <span class="s1">description </span><span class="s3">= </span><span class="s1">description</span><span class="s3">[</span><span class="s1">len</span><span class="s3">(</span><span class="s1">name</span><span class="s3">) + </span><span class="s5">2</span><span class="s3">:]</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">min_index </span><span class="s3">= </span><span class="s1">_get_splice_index</span><span class="s3">(</span><span class="s1">nearest_mention</span><span class="s3">, </span><span class="s1">nearest_hash</span><span class="s3">, </span><span class="s1">description</span><span class="s3">)</span>

                <span class="s1">desc</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s1">description</span><span class="s3">[:</span><span class="s1">min_index</span><span class="s3">])</span>
                <span class="s1">description </span><span class="s3">= </span><span class="s1">description</span><span class="s3">[</span><span class="s1">min_index</span><span class="s3">:]</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">exception</span><span class="s3">:</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s4">'Failed to set description: '</span><span class="s3">, </span><span class="s1">exception</span><span class="s3">)</span>
        <span class="s1">_clear</span><span class="s3">(</span><span class="s1">desc</span><span class="s3">)</span>
        <span class="s1">desc</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s1">saved_description</span><span class="s3">) </span><span class="s6"># if fail, use saved description</span>


<span class="s2">def </span><span class="s1">_clear</span><span class="s3">(</span><span class="s1">element</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Clears the text of the element (an issue with the TikTok website when automating) 
 
    Parameters 
    ---------- 
    element 
        The text box to clear 
    &quot;&quot;&quot;</span>
    <span class="s1">element</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s5">2 </span><span class="s3">* </span><span class="s1">len</span><span class="s3">(</span><span class="s1">element</span><span class="s3">.</span><span class="s1">text</span><span class="s3">) * </span><span class="s1">Keys</span><span class="s3">.</span><span class="s1">BACKSPACE</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_set_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">path</span><span class="s3">: </span><span class="s1">str </span><span class="s3">= </span><span class="s4">''</span><span class="s3">, </span><span class="s1">num_retries</span><span class="s3">: </span><span class="s1">int </span><span class="s3">= </span><span class="s5">3</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Sets the video to upload 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    path : str 
        The path to the video to upload 
    num_retries : number of retries (can occasionally fail) 
    &quot;&quot;&quot;</span>
    <span class="s6"># uploads the element</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Uploading video file'</span><span class="s3">))</span>

    <span class="s2">for </span><span class="s1">_ </span><span class="s2">in </span><span class="s1">range</span><span class="s3">(</span><span class="s1">num_retries</span><span class="s3">):</span>
        <span class="s2">try</span><span class="s3">:</span>
            <span class="s1">upload_box </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span>
                <span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'upload_video'</span><span class="s3">]</span>
            <span class="s3">)</span>
            <span class="s1">upload_box</span><span class="s3">.</span><span class="s1">send_keys</span><span class="s3">(</span><span class="s1">path</span><span class="s3">)</span>
            <span class="s6"># waits for the upload progress bar to disappear</span>
            <span class="s1">upload_progress </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'upload_in_progress'</span><span class="s3">])</span>
                <span class="s3">)</span>

            <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">upload_progress</span><span class="s3">)</span>
            <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until_not</span><span class="s3">(</span><span class="s1">upload_progress</span><span class="s3">)</span>

            <span class="s6"># waits for the video to upload</span>
            <span class="s1">upload_confirmation </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'upload_confirmation'</span><span class="s3">])</span>
                <span class="s3">)</span>

            <span class="s6"># An exception throw here means the video failed to upload an a retry is needed</span>
            <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">upload_confirmation</span><span class="s3">)</span>

            <span class="s6"># wait until a non-draggable image is found</span>
            <span class="s1">process_confirmation </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
                <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'process_confirmation'</span><span class="s3">])</span>
                <span class="s3">)</span>
            <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">process_confirmation</span><span class="s3">)</span>
            <span class="s2">return</span>
        <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">exception</span><span class="s3">:</span>
            <span class="s1">print</span><span class="s3">(</span><span class="s1">exception</span><span class="s3">)</span>

    <span class="s2">raise </span><span class="s1">FailedToUpload</span><span class="s3">()</span>


<span class="s2">def </span><span class="s1">_set_interactivity</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">comment</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">stitch</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, </span><span class="s1">duet</span><span class="s3">=</span><span class="s2">True</span><span class="s3">, *</span><span class="s1">args</span><span class="s3">, **</span><span class="s1">kwargs</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Sets the interactivity settings of the video 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    comment : bool 
        Whether or not to allow comments 
    stitch : bool 
        Whether or not to allow stitching 
    duet : bool 
        Whether or not to allow duets 
    &quot;&quot;&quot;</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Setting interactivity settings'</span><span class="s3">))</span>

        <span class="s1">comment_box </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'comment'</span><span class="s3">])</span>
        <span class="s1">stitch_box </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'stitch'</span><span class="s3">])</span>
        <span class="s1">duet_box </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'duet'</span><span class="s3">])</span>

        <span class="s6"># xor the current state with the desired state</span>
        <span class="s2">if </span><span class="s1">comment </span><span class="s3">^ </span><span class="s1">comment_box</span><span class="s3">.</span><span class="s1">is_selected</span><span class="s3">():</span>
            <span class="s1">comment_box</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">stitch </span><span class="s3">^ </span><span class="s1">stitch_box</span><span class="s3">.</span><span class="s1">is_selected</span><span class="s3">():</span>
            <span class="s1">stitch_box</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

        <span class="s2">if </span><span class="s1">duet </span><span class="s3">^ </span><span class="s1">duet_box</span><span class="s3">.</span><span class="s1">is_selected</span><span class="s3">():</span>
            <span class="s1">duet_box</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">_</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s4">'Failed to set interactivity settings'</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_set_schedule_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">schedule</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Sets the schedule of the video 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    schedule : datetime.datetime 
        The datetime to set 
    &quot;&quot;&quot;</span>

    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Setting schedule'</span><span class="s3">))</span>

    <span class="s1">driver_timezone </span><span class="s3">= </span><span class="s1">__get_driver_timezone</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">)</span>
    <span class="s1">schedule </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">astimezone</span><span class="s3">(</span><span class="s1">driver_timezone</span><span class="s3">)</span>

    <span class="s1">month </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">month</span>
    <span class="s1">day </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">day</span>
    <span class="s1">hour </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">hour</span>
    <span class="s1">minute </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">minute</span>

    <span class="s2">try</span><span class="s3">:</span>
        <span class="s1">switch </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'switch'</span><span class="s3">])</span>
        <span class="s1">switch</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>
        <span class="s1">__date_picker</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">month</span><span class="s3">, </span><span class="s1">day</span><span class="s3">)</span>
        <span class="s1">__time_picker</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">hour</span><span class="s3">, </span><span class="s1">minute</span><span class="s3">)</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">f'Failed to set schedule: </span><span class="s2">{</span><span class="s1">e</span><span class="s2">}</span><span class="s4">'</span>
        <span class="s1">print</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">FailedToUpload</span><span class="s3">()</span>



<span class="s2">def </span><span class="s1">__date_picker</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">month</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">day</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Picking date'</span><span class="s3">))</span>

    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'date_picker'</span><span class="s3">])</span>
        <span class="s3">)</span>
    <span class="s1">date_picker </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>
    <span class="s1">date_picker</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'calendar'</span><span class="s3">])</span>
    <span class="s3">)</span>
    <span class="s1">calendar </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>

    <span class="s1">calendar_month </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'calendar_month'</span><span class="s3">]).</span><span class="s1">text</span>
    <span class="s1">n_calendar_month </span><span class="s3">= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">strptime</span><span class="s3">(</span><span class="s1">calendar_month</span><span class="s3">, </span><span class="s4">'%B'</span><span class="s3">).</span><span class="s1">month</span>
    <span class="s2">if </span><span class="s1">n_calendar_month </span><span class="s3">!= </span><span class="s1">month</span><span class="s3">:  </span><span class="s6"># Max can be a month before or after</span>
        <span class="s2">if </span><span class="s1">n_calendar_month </span><span class="s3">&lt; </span><span class="s1">month</span><span class="s3">:</span>
            <span class="s1">arrow </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_elements</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'calendar_arrows'</span><span class="s3">])[-</span><span class="s5">1</span><span class="s3">]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s1">arrow </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_elements</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'calendar_arrows'</span><span class="s3">])[</span><span class="s5">0</span><span class="s3">]</span>
        <span class="s1">arrow</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>
    <span class="s1">valid_days </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_elements</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'calendar_valid_days'</span><span class="s3">])</span>

    <span class="s1">day_to_click </span><span class="s3">= </span><span class="s2">None</span>
    <span class="s2">for </span><span class="s1">day_option </span><span class="s2">in </span><span class="s1">valid_days</span><span class="s3">:</span>
        <span class="s2">if </span><span class="s1">int</span><span class="s3">(</span><span class="s1">day_option</span><span class="s3">.</span><span class="s1">text</span><span class="s3">) == </span><span class="s1">day</span><span class="s3">:</span>
            <span class="s1">day_to_click </span><span class="s3">= </span><span class="s1">day_option</span>
            <span class="s2">break</span>
    <span class="s2">if </span><span class="s1">day_to_click</span><span class="s3">:</span>
        <span class="s1">day_to_click</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s4">'Day not found in calendar'</span><span class="s3">)</span>

    <span class="s1">__verify_date_picked_is_correct</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">month</span><span class="s3">, </span><span class="s1">day</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">__verify_date_picked_is_correct</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">month</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">day</span><span class="s3">: </span><span class="s1">int</span><span class="s3">):</span>
    <span class="s1">date_selected </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'date_picker'</span><span class="s3">]).</span><span class="s1">text</span>
    <span class="s1">date_selected_month </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">date_selected</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">])</span>
    <span class="s1">date_selected_day </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">date_selected</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'-'</span><span class="s3">)[</span><span class="s5">2</span><span class="s3">])</span>

    <span class="s2">if </span><span class="s1">date_selected_month </span><span class="s3">== </span><span class="s1">month </span><span class="s2">and </span><span class="s1">date_selected_day </span><span class="s3">== </span><span class="s1">day</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Date picked correctly'</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">f'Something went wrong with the date picker, expected </span><span class="s2">{</span><span class="s1">month</span><span class="s2">}</span><span class="s4">-</span><span class="s2">{</span><span class="s1">day</span><span class="s2">} </span><span class="s4">but got </span><span class="s2">{</span><span class="s1">date_selected_month</span><span class="s2">}</span><span class="s4">-</span><span class="s2">{</span><span class="s1">date_selected_day</span><span class="s2">}</span><span class="s4">'</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">__time_picker</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">hour</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">minute</span><span class="s3">: </span><span class="s1">int</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Picking time'</span><span class="s3">))</span>

    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'time_picker'</span><span class="s3">])</span>
        <span class="s3">)</span>
    <span class="s1">time_picker </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>
    <span class="s1">time_picker</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s1">condition </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'time_picker_container'</span><span class="s3">])</span>
    <span class="s3">)</span>
    <span class="s1">time_picker_container </span><span class="s3">= </span><span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'implicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">condition</span><span class="s3">)</span>

    <span class="s6"># 00 = 0, 01 = 1, 02 = 2, 03 = 3, 04 = 4, 05 = 5, 06 = 6, 07 = 7, 08 = 8, 09 = 9, 10 = 10, 11 = 11, 12 = 12,</span>
    <span class="s6"># 13 = 13, 14 = 14, 15 = 15, 16 = 16, 17 = 17, 18 = 18, 19 = 19, 20 = 20, 21 = 21, 22 = 22, 23 = 23</span>
    <span class="s1">hour_options </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_elements</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'timepicker_hours'</span><span class="s3">])</span>
    <span class="s6"># 00 == 0, 05 == 1, 10 == 2, 15 == 3, 20 == 4, 25 == 5, 30 == 6, 35 == 7, 40 == 8, 45 == 9, 50 == 10, 55 == 11</span>
    <span class="s1">minute_options </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_elements</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'timepicker_minutes'</span><span class="s3">])</span>

    <span class="s1">hour_to_click </span><span class="s3">= </span><span class="s1">hour_options</span><span class="s3">[</span><span class="s1">hour</span><span class="s3">]</span>
    <span class="s1">minute_option_correct_index </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">minute </span><span class="s3">/ </span><span class="s5">5</span><span class="s3">)</span>
    <span class="s1">minute_to_click </span><span class="s3">= </span><span class="s1">minute_options</span><span class="s3">[</span><span class="s1">minute_option_correct_index</span><span class="s3">]</span>

    <span class="s1">driver</span><span class="s3">.</span><span class="s1">execute_script</span><span class="s3">(</span><span class="s4">&quot;arguments[0].scrollIntoView({block: 'center', inline: 'nearest'});&quot;</span><span class="s3">, </span><span class="s1">hour_to_click</span><span class="s3">)</span>
    <span class="s1">hour_to_click</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>
    <span class="s1">driver</span><span class="s3">.</span><span class="s1">execute_script</span><span class="s3">(</span><span class="s4">&quot;arguments[0].scrollIntoView({block: 'center', inline: 'nearest'});&quot;</span><span class="s3">, </span><span class="s1">minute_to_click</span><span class="s3">)</span>
    <span class="s1">minute_to_click</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s6"># click somewhere else to close the time picker</span>
    <span class="s1">time_picker</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s1">time</span><span class="s3">.</span><span class="s1">sleep</span><span class="s3">(</span><span class="s5">.5</span><span class="s3">)  </span><span class="s6"># wait for the DOM change</span>
    <span class="s1">__verify_time_picked_is_correct</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">hour</span><span class="s3">, </span><span class="s1">minute</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">__verify_time_picked_is_correct</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">hour</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">minute</span><span class="s3">: </span><span class="s1">int</span><span class="s3">):</span>
    <span class="s1">time_selected </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'schedule'</span><span class="s3">][</span><span class="s4">'time_picker_text'</span><span class="s3">]).</span><span class="s1">text</span>
    <span class="s1">time_selected_hour </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">time_selected</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">)[</span><span class="s5">0</span><span class="s3">])</span>
    <span class="s1">time_selected_minute </span><span class="s3">= </span><span class="s1">int</span><span class="s3">(</span><span class="s1">time_selected</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">':'</span><span class="s3">)[</span><span class="s5">1</span><span class="s3">])</span>

    <span class="s2">if </span><span class="s1">time_selected_hour </span><span class="s3">== </span><span class="s1">hour </span><span class="s2">and </span><span class="s1">time_selected_minute </span><span class="s3">== </span><span class="s1">minute</span><span class="s3">:</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Time picked correctly'</span><span class="s3">))</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s1">msg </span><span class="s3">= </span><span class="s4">f'Something went wrong with the time picker, ' </span><span class="s1">\</span>
              <span class="s4">f'expected </span><span class="s2">{</span><span class="s1">hour</span><span class="s2">:</span><span class="s4">02d</span><span class="s2">}</span><span class="s4">:</span><span class="s2">{</span><span class="s1">minute</span><span class="s2">:</span><span class="s4">02d</span><span class="s2">} </span><span class="s4">' </span><span class="s1">\</span>
              <span class="s4">f'but got </span><span class="s2">{</span><span class="s1">time_selected_hour</span><span class="s2">:</span><span class="s4">02d</span><span class="s2">}</span><span class="s4">:</span><span class="s2">{</span><span class="s1">time_selected_minute</span><span class="s2">:</span><span class="s4">02d</span><span class="s2">}</span><span class="s4">'</span>
        <span class="s1">logger</span><span class="s3">.</span><span class="s1">error</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>
        <span class="s2">raise </span><span class="s1">Exception</span><span class="s3">(</span><span class="s1">msg</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_post_video</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Posts the video by clicking the post button 
 
    Parameters 
    ---------- 
    driver : selenium.webdriver 
    &quot;&quot;&quot;</span>
    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Clicking the post button'</span><span class="s3">))</span>

    <span class="s1">post </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">find_element</span><span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'post'</span><span class="s3">])</span>
    <span class="s1">post</span><span class="s3">.</span><span class="s1">click</span><span class="s3">()</span>

    <span class="s6"># waits for the video to upload</span>
    <span class="s1">post_confirmation </span><span class="s3">= </span><span class="s1">EC</span><span class="s3">.</span><span class="s1">presence_of_element_located</span><span class="s3">(</span>
        <span class="s3">(</span><span class="s1">By</span><span class="s3">.</span><span class="s1">XPATH</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'selectors'</span><span class="s3">][</span><span class="s4">'upload'</span><span class="s3">][</span><span class="s4">'post_confirmation'</span><span class="s3">])</span>
        <span class="s3">)</span>
    <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">post_confirmation</span><span class="s3">)</span>

    <span class="s1">logger</span><span class="s3">.</span><span class="s1">debug</span><span class="s3">(</span><span class="s1">green</span><span class="s3">(</span><span class="s4">'Video posted successfully'</span><span class="s3">))</span>


<span class="s6"># HELPERS</span>

<span class="s2">def </span><span class="s1">_check_valid_path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Returns whether or not the filetype is supported by TikTok 
    &quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">exists</span><span class="s3">(</span><span class="s1">path</span><span class="s3">) </span><span class="s2">and </span><span class="s1">path</span><span class="s3">.</span><span class="s1">split</span><span class="s3">(</span><span class="s4">'.'</span><span class="s3">)[-</span><span class="s5">1</span><span class="s3">] </span><span class="s2">in </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'supported_file_types'</span><span class="s3">]</span>


<span class="s2">def </span><span class="s1">_get_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">, </span><span class="s1">valid_multiple</span><span class="s3">) </span><span class="s1">-&gt; datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Returns a datetime.datetime with valid minute for TikTok 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">_is_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">minute</span><span class="s3">, </span><span class="s1">valid_multiple</span><span class="s3">):</span>
        <span class="s2">return </span><span class="s1">schedule</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">_set_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">, </span><span class="s1">valid_multiple</span><span class="s3">)</span>


<span class="s2">def </span><span class="s1">_is_valid_schedule_minute</span><span class="s3">(</span><span class="s1">minute</span><span class="s3">, </span><span class="s1">valid_multiple</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s2">if </span><span class="s1">minute </span><span class="s3">% </span><span class="s1">valid_multiple </span><span class="s3">!= </span><span class="s5">0</span><span class="s3">:</span>
        <span class="s2">return False</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return True</span>


<span class="s2">def </span><span class="s1">_set_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">, </span><span class="s1">valid_multiple</span><span class="s3">) </span><span class="s1">-&gt; datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">:</span>
    <span class="s1">minute </span><span class="s3">= </span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">minute</span>

    <span class="s1">remainder </span><span class="s3">= </span><span class="s1">minute </span><span class="s3">% </span><span class="s1">valid_multiple</span>
    <span class="s1">integers_to_valid_multiple </span><span class="s3">= </span><span class="s5">5 </span><span class="s3">- </span><span class="s1">remainder</span>
    <span class="s1">schedule </span><span class="s3">+= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">minutes</span><span class="s3">=</span><span class="s1">integers_to_valid_multiple</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">schedule</span>


<span class="s2">def </span><span class="s1">_check_valid_schedule</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">: </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">) </span><span class="s1">-&gt; bool</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Returns if the schedule is supported by TikTok 
    &quot;&quot;&quot;</span>
    <span class="s1">valid_tiktok_minute_multiple </span><span class="s3">= </span><span class="s5">5</span>
    <span class="s1">margin_to_complete_upload_form </span><span class="s3">= </span><span class="s5">5</span>

    <span class="s1">datetime_utc_now </span><span class="s3">= </span><span class="s1">pytz</span><span class="s3">.</span><span class="s1">UTC</span><span class="s3">.</span><span class="s1">localize</span><span class="s3">(</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">utcnow</span><span class="s3">())</span>
    <span class="s1">min_datetime_tiktok_valid </span><span class="s3">= </span><span class="s1">datetime_utc_now </span><span class="s3">+ </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">minutes</span><span class="s3">=</span><span class="s5">15</span><span class="s3">)</span>
    <span class="s1">min_datetime_tiktok_valid </span><span class="s3">+= </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">minutes</span><span class="s3">=</span><span class="s1">margin_to_complete_upload_form</span><span class="s3">)</span>
    <span class="s1">max_datetime_tiktok_valid </span><span class="s3">= </span><span class="s1">datetime_utc_now </span><span class="s3">+ </span><span class="s1">datetime</span><span class="s3">.</span><span class="s1">timedelta</span><span class="s3">(</span><span class="s1">days</span><span class="s3">=</span><span class="s5">10</span><span class="s3">)</span>
    <span class="s2">if </span><span class="s1">schedule </span><span class="s3">&lt; </span><span class="s1">min_datetime_tiktok_valid \</span>
            <span class="s2">or </span><span class="s1">schedule </span><span class="s3">&gt; </span><span class="s1">max_datetime_tiktok_valid</span><span class="s3">:</span>
        <span class="s2">return False</span>
    <span class="s2">elif not </span><span class="s1">_is_valid_schedule_minute</span><span class="s3">(</span><span class="s1">schedule</span><span class="s3">.</span><span class="s1">minute</span><span class="s3">, </span><span class="s1">valid_tiktok_minute_multiple</span><span class="s3">):</span>
        <span class="s2">return False</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return True</span>


<span class="s2">def </span><span class="s1">_get_splice_index</span><span class="s3">(</span><span class="s1">nearest_mention</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">nearest_hashtag</span><span class="s3">: </span><span class="s1">int</span><span class="s3">, </span><span class="s1">description</span><span class="s3">: </span><span class="s1">str</span><span class="s3">) </span><span class="s1">-&gt; int</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Returns the index to splice the description at 
 
    Parameters 
    ---------- 
    nearest_mention : int 
        The index of the nearest mention 
    nearest_hashtag : int 
        The index of the nearest hashtag 
 
    Returns 
    ------- 
    int 
        The index to splice the description at 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">nearest_mention </span><span class="s3">== -</span><span class="s5">1 </span><span class="s2">and </span><span class="s1">nearest_hashtag </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">len</span><span class="s3">(</span><span class="s1">description</span><span class="s3">)</span>
    <span class="s2">elif </span><span class="s1">nearest_hashtag </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">nearest_mention</span>
    <span class="s2">elif </span><span class="s1">nearest_mention </span><span class="s3">== -</span><span class="s5">1</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">nearest_hashtag</span>
    <span class="s2">else</span><span class="s3">:</span>
        <span class="s2">return </span><span class="s1">min</span><span class="s3">(</span><span class="s1">nearest_mention</span><span class="s3">, </span><span class="s1">nearest_hashtag</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">_convert_videos_dict</span><span class="s3">(</span><span class="s1">videos_list_of_dictionaries</span><span class="s3">) </span><span class="s1">-&gt; List</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Takes in a videos dictionary and converts it. 
 
    This allows the user to use the wrong stuff and thing to just work 
    &quot;&quot;&quot;</span>
    <span class="s2">if not </span><span class="s1">videos_list_of_dictionaries</span><span class="s3">:</span>
        <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">&quot;No videos to upload&quot;</span><span class="s3">)</span>

    <span class="s1">valid_path </span><span class="s3">= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'valid_path_names'</span><span class="s3">]</span>
    <span class="s1">valid_description </span><span class="s3">= </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'valid_descriptions'</span><span class="s3">]</span>

    <span class="s1">correct_path </span><span class="s3">= </span><span class="s1">valid_path</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>
    <span class="s1">correct_description </span><span class="s3">= </span><span class="s1">valid_description</span><span class="s3">[</span><span class="s5">0</span><span class="s3">]</span>

    <span class="s2">def </span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">lst1</span><span class="s3">, </span><span class="s1">lst2</span><span class="s3">):</span>
        <span class="s0">&quot;&quot;&quot; return the intersection of two lists &quot;&quot;&quot;</span>
        <span class="s2">return </span><span class="s1">list</span><span class="s3">(</span><span class="s1">set</span><span class="s3">(</span><span class="s1">lst1</span><span class="s3">) &amp; </span><span class="s1">set</span><span class="s3">(</span><span class="s1">lst2</span><span class="s3">))</span>

    <span class="s1">return_list </span><span class="s3">= []</span>
    <span class="s2">for </span><span class="s1">elem </span><span class="s2">in </span><span class="s1">videos_list_of_dictionaries</span><span class="s3">:</span>
        <span class="s6"># preprocess the dictionary</span>
        <span class="s1">elem </span><span class="s3">= {</span><span class="s1">k</span><span class="s3">.</span><span class="s1">strip</span><span class="s3">().</span><span class="s1">lower</span><span class="s3">(): </span><span class="s1">v </span><span class="s2">for </span><span class="s1">k</span><span class="s3">, </span><span class="s1">v </span><span class="s2">in </span><span class="s1">elem</span><span class="s3">.</span><span class="s1">items</span><span class="s3">()}</span>

        <span class="s1">keys </span><span class="s3">= </span><span class="s1">elem</span><span class="s3">.</span><span class="s1">keys</span><span class="s3">()</span>
        <span class="s1">path_intersection </span><span class="s3">= </span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">valid_path</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">)</span>
        <span class="s1">description_intersection </span><span class="s3">= </span><span class="s1">intersection</span><span class="s3">(</span><span class="s1">valid_description</span><span class="s3">, </span><span class="s1">keys</span><span class="s3">)</span>

        <span class="s2">if </span><span class="s1">path_intersection</span><span class="s3">:</span>
            <span class="s6"># we have a path</span>
            <span class="s1">path </span><span class="s3">= </span><span class="s1">elem</span><span class="s3">[</span><span class="s1">path_intersection</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()]</span>

            <span class="s2">if not </span><span class="s1">_check_valid_path</span><span class="s3">(</span><span class="s1">path</span><span class="s3">):</span>
                <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">&quot;Invalid path: &quot; </span><span class="s3">+ </span><span class="s1">path</span><span class="s3">)</span>

            <span class="s1">elem</span><span class="s3">[</span><span class="s1">correct_path</span><span class="s3">] = </span><span class="s1">path</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># iterates over the elem and find a key which is a path with a valid extension</span>
            <span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">elem</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if </span><span class="s1">_check_valid_path</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                    <span class="s1">elem</span><span class="s3">[</span><span class="s1">correct_path</span><span class="s3">] = </span><span class="s1">value</span>
                    <span class="s2">break</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s6"># no valid path found</span>
                <span class="s2">raise </span><span class="s1">RuntimeError</span><span class="s3">(</span><span class="s4">&quot;Path not found in dictionary: &quot; </span><span class="s3">+ </span><span class="s1">str</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">))</span>

        <span class="s2">if </span><span class="s1">description_intersection</span><span class="s3">:</span>
            <span class="s6"># we have a description</span>
            <span class="s1">elem</span><span class="s3">[</span><span class="s1">correct_description</span><span class="s3">] = </span><span class="s1">elem</span><span class="s3">[</span><span class="s1">description_intersection</span><span class="s3">.</span><span class="s1">pop</span><span class="s3">()]</span>
        <span class="s2">else</span><span class="s3">:</span>
            <span class="s6"># iterates over the elem and finds a description which is not a valid path</span>
            <span class="s2">for </span><span class="s1">_</span><span class="s3">, </span><span class="s1">value </span><span class="s2">in </span><span class="s1">elem</span><span class="s3">.</span><span class="s1">items</span><span class="s3">():</span>
                <span class="s2">if not </span><span class="s1">_check_valid_path</span><span class="s3">(</span><span class="s1">value</span><span class="s3">):</span>
                    <span class="s1">elem</span><span class="s3">[</span><span class="s1">correct_description</span><span class="s3">] = </span><span class="s1">value</span>
                    <span class="s2">break</span>
            <span class="s2">else</span><span class="s3">:</span>
                <span class="s1">elem</span><span class="s3">[</span><span class="s1">correct_description</span><span class="s3">] = </span><span class="s4">'' </span><span class="s6"># null description is fine</span>

        <span class="s1">return_list</span><span class="s3">.</span><span class="s1">append</span><span class="s3">(</span><span class="s1">elem</span><span class="s3">)</span>

    <span class="s2">return </span><span class="s1">return_list</span>

<span class="s2">def </span><span class="s1">__get_driver_timezone</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">) </span><span class="s1">-&gt; pytz</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">:</span>
    <span class="s0">&quot;&quot;&quot; 
    Returns the timezone of the driver 
    &quot;&quot;&quot;</span>
    <span class="s1">timezone_str </span><span class="s3">= </span><span class="s1">driver</span><span class="s3">.</span><span class="s1">execute_script</span><span class="s3">(</span><span class="s4">&quot;return Intl.DateTimeFormat().resolvedOptions().timeZone&quot;</span><span class="s3">)</span>
    <span class="s2">return </span><span class="s1">pytz</span><span class="s3">.</span><span class="s1">timezone</span><span class="s3">(</span><span class="s1">timezone_str</span><span class="s3">)</span>

<span class="s2">def </span><span class="s1">_refresh_with_alert</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">) </span><span class="s1">-&gt; </span><span class="s2">None</span><span class="s3">:</span>
    <span class="s2">try</span><span class="s3">:</span>
        <span class="s6"># attempt to refresh the page</span>
        <span class="s1">driver</span><span class="s3">.</span><span class="s1">refresh</span><span class="s3">()</span>

        <span class="s6"># wait for the alert to appear</span>
        <span class="s1">WebDriverWait</span><span class="s3">(</span><span class="s1">driver</span><span class="s3">, </span><span class="s1">config</span><span class="s3">[</span><span class="s4">'explicit_wait'</span><span class="s3">]).</span><span class="s1">until</span><span class="s3">(</span><span class="s1">EC</span><span class="s3">.</span><span class="s1">alert_is_present</span><span class="s3">())</span>

        <span class="s6"># accept the alert</span>
        <span class="s1">driver</span><span class="s3">.</span><span class="s1">switch_to</span><span class="s3">.</span><span class="s1">alert</span><span class="s3">.</span><span class="s1">accept</span><span class="s3">()</span>
    <span class="s2">except</span><span class="s3">:</span>
        <span class="s6"># if no alert appears, the page is fine</span>
        <span class="s2">pass</span>

<span class="s2">class </span><span class="s1">DescriptionTooLong</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    A video description longer than the maximum allowed by TikTok's website (not app) uploader 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">message </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__doc__</span><span class="s3">)</span>


<span class="s2">class </span><span class="s1">FailedToUpload</span><span class="s3">(</span><span class="s1">Exception</span><span class="s3">):</span>
    <span class="s0">&quot;&quot;&quot; 
    A video failed to upload 
    &quot;&quot;&quot;</span>

    <span class="s2">def </span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">self</span><span class="s3">, </span><span class="s1">message</span><span class="s3">=</span><span class="s2">None</span><span class="s3">):</span>
        <span class="s1">super</span><span class="s3">().</span><span class="s1">__init__</span><span class="s3">(</span><span class="s1">message </span><span class="s2">or </span><span class="s1">self</span><span class="s3">.</span><span class="s1">__doc__</span><span class="s3">)</span></pre>
</body>
</html>